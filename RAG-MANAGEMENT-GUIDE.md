# RAG 管理模块使用指南

## 📋 概述

RAG 管理模块是 TripNara 后台管理系统中的核心功能，用于管理知识库、文档、检索、评估等功能。所有功能都通过 Next.js API 路由代理到后端服务 `http://localhost:3000/api`。

---

## 🎯 功能标签页说明

### 1. 📊 统计 (Stats)

**用途**: 查看 RAG 知识库的整体统计信息

**使用方法**:
1. 选择集合（可选）：可以选择特定集合查看统计，或选择"全部集合"查看整体统计
2. 点击"获取统计"按钮
3. 查看统计结果：
   - **总文档数**: 知识库中的文档总数
   - **集合数量**: 已创建的集合数量
   - **集合统计详情**: 各集合的文档分布、国家/地区、标签等信息

**适用场景**:
- 了解知识库的整体规模
- 查看各集合的文档分布情况
- 监控知识库的增长情况

---

### 2. 📄 文档管理 (Documents)

**用途**: 查看、编辑、删除 RAG 知识库中的文档

**使用方法**:
1. **筛选文档**:
   - 选择集合（travel_guides、compliance_rules 等）
   - 输入国家代码（如 IS、JP）
   - 输入标签（逗号分隔，如 `attractions, tips`）
   - 输入搜索关键词（搜索标题或内容）
   - 点击搜索按钮

2. **查看文档列表**:
   - 左侧显示文档列表，支持分页
   - 点击文档可查看详情

3. **编辑文档**:
   - 选择文档后，右侧显示编辑表单
   - 可以修改标题、内容、标签、元数据等
   - 更新内容后会自动重新生成 embedding

4. **删除文档**:
   - 点击文档列表中的删除按钮
   - 确认后删除文档

**适用场景**:
- 日常文档维护和更新
- 修正文档内容错误
- 添加或更新文档标签
- 删除过时或错误的文档

---

### 3. 📤 索引 (Index)

**用途**: 将文档添加到 RAG 知识库索引

**使用方法**:

#### 单个索引
1. 填写文档信息：
   - 集合名称（如 `travel_guides`）
   - 标题
   - 内容
   - 国家代码（可选）
   - 标签（逗号分隔）
   - 来源（如 `manual`）
   - 元数据（JSON 格式，可选）

2. 点击"索引文档"按钮
3. 等待处理完成（会自动生成 embedding）

#### 批量索引
1. **格式 1: 文档数组**
   ```json
   [
     {
       "collection": "travel_guides",
       "title": "文档1",
       "content": "内容1",
       ...
     },
     {
       "collection": "travel_guides",
       "title": "文档2",
       "content": "内容2",
       ...
     }
   ]
   ```

2. **格式 2: 路线 JSON**（推荐）
   ```json
   {
     "route": {
       "route_id": "iceland_golden_circle_001",
       "route_name": "黄金圈",
       "key_stops": [...],
       "risk_assessment": {...},
       "seasonal_variations": {...}
     },
     "metadata": {...}
   }
   ```
   - 系统会自动将路线 JSON 转换为多个文档：
     - 路线概述 → 1 个文档
     - 每个站点 → 1 个文档
     - 风险评估 → 1 个文档
     - 每个季节 → 1 个文档
     - 决策支持 → 1 个文档

**适用场景**:
- 添加新的旅行指南文档
- 批量导入路线数据
- 更新知识库内容

---

### 4. 🗄️ 知识库 (Knowledge Base)

**用途**: 管理知识库索引的完整重建和清空

**使用方法**:

#### 重建索引 ⭐
1. 点击"重建索引"按钮
2. 系统会：
   - 清空现有索引
   - 扫描 `KB_PATH` 目录（默认: `./docs/iceland`）
   - 为每个 JSON 文件生成 embedding
   - 存储到 `knowledge_files` 和 `chunks` 表
3. **执行时间**: 约 10-20 分钟（23 个文件）
4. 重建完成后会显示成功消息

**适用场景**:
- 首次设置知识库
- 更新了知识库文件后需要重新索引
- 修复索引问题

#### 清空索引 ⚠️
1. 点击"清空索引"按钮
2. **警告**: 此操作将删除所有知识库数据！
   - 删除所有 `knowledge_files` 记录
   - 删除所有 `chunks` 记录
   - 删除所有 embedding 向量
3. 确认后执行清空操作

**适用场景**:
- 需要完全重置知识库
- 准备重新构建索引

---

### 5. 🔍 检索测试 (Retrieve)

**用途**: 测试 RAG 检索接口，验证检索效果

**使用方法**:

1. **选择检索类型**:
   - **Chunk 检索（新，推荐）⭐**: 使用新的知识库系统，从 Chunk 表检索
   - **RAG 搜索**: 使用 RAG 搜索接口
   - **传统检索（旧）**: 使用旧的检索接口（保留兼容性）

2. **填写查询参数**:
   - **查询文本** *: 输入要查询的内容（如：`冰岛租车保险`）
   - **返回数量**: 设置返回结果数量（1-50）
   - **最小可信度**（仅 Chunk 检索）: 设置最小可信度阈值（0-1）
   - **集合**（RAG 搜索/传统检索）: 指定集合名称
   - **国家代码**（RAG 搜索/传统检索）: 指定国家代码

3. 点击"开始检索"按钮
4. 查看检索结果：
   - 显示检索到的文档列表
   - 每个结果显示标题、内容预览、相似度、可信度等信息

**适用场景**:
- 测试检索效果
- 调试检索问题
- 验证知识库内容是否被正确索引
- 比较不同检索接口的效果

---

### 6. 🛡️ 合规规则 (Compliance)

**用途**: 管理合规规则缓存和提取特定规则

**使用方法**:

#### 刷新合规规则缓存
1. 点击"刷新合规规则"按钮
2. 系统会重新加载知识库中的合规规则文档
3. **注意**: 刷新操作是异步的，返回成功只表示刷新任务已启动

#### 提取 Rail Pass 规则
1. 输入 Pass 类型（如：`Eurail Global Pass`）
2. 输入国家代码（可选，如：`IS`）
3. 点击"提取规则"按钮
4. 查看提取结果

#### 提取 Trail Access 规则
1. 输入路线 ID（如：`laugavegur`）
2. 输入国家代码（可选）
3. 点击"提取规则"按钮
4. 查看提取结果

#### 刷新当地洞察缓存
1. 填写表单：
   - 国家代码 *（如：`IS`）
   - 标签 *（逗号分隔，如：`culture, tips, etiquette`）
   - 地区（可选，如：`Reykjavik`）
2. 点击"刷新当地洞察"按钮
3. 查看刷新结果

**适用场景**:
- 更新合规规则后刷新缓存
- 提取特定类型的合规规则供业务使用
- 刷新特定地区的当地洞察信息

---

### 7. 📖 叙事生成 (Narrative)

**用途**: 生成路线叙事和路线段叙事

**使用方法**:

#### 生成路线叙事
1. 输入路线方向 ID（如：`route_001`）
2. 输入国家代码（可选）
3. 选择是否包含当地洞察
4. 点击"生成路线叙事"按钮
5. 查看生成的叙事内容

#### 生成路线段叙事
1. 填写表单：
   - 路线段 ID *（如：`seg_001`）
   - 天数索引 *（如：`1`）
   - 名称 *（如：`从雷克雅未克到黄金圈`）
   - 描述 *（如：`第一天行程`）
   - 国家代码 *（如：`IS`）
2. 点击"生成路线段叙事"按钮
3. 查看生成的叙事内容

**适用场景**:
- 为路线生成描述性文本
- 为行程生成每日叙事
- 生成用户友好的路线介绍

---

### 8. ✅ 评估 (Evaluation)

**用途**: 评估 RAG 检索质量

**使用方法**:

#### 单次评估
1. 填写评估参数：
   - 查询文本 *
   - 集合、国家代码、标签等检索参数
   - 正确答案文档 ID *（逗号分隔）
2. 点击"评估"按钮
3. 查看评估结果：
   - Recall@K（召回率）
   - MRR（平均倒数排名）
   - NDCG（归一化折损累积增益）
   - 其他指标

#### 批量评估
1. 准备测试用例 JSON：
   ```json
   [
     {
       "query": "查询1",
       "params": {...},
       "groundTruthDocumentIds": [...]
     },
     {
       "query": "查询2",
       "params": {...},
       "groundTruthDocumentIds": [...]
     }
   ]
   ```
2. 粘贴到文本框中
3. 点击"批量评估"按钮
4. 查看批量评估结果

**适用场景**:
- 评估检索系统性能
- 优化检索参数
- 验证知识库质量
- 对比不同检索策略的效果

---

### 9. 📝 Query-Pairs

**用途**: 收集和管理 query-document 对，用于评估和优化

**使用方法**:

#### 收集 Query-Document 对
1. 填写表单：
   - 查询文本 *
   - 正确答案文档 ID *（逗号分隔）
   - 元数据（JSON 格式，可选）
2. 点击"收集"按钮

#### 从用户查询自动收集
1. 填写表单：
   - 查询文本 *
   - 检索结果（JSON 格式）
   - 用户反馈（点击的文档、相关文档、不相关文档）
2. 点击"收集"按钮

#### 批量收集
1. 准备 JSON 数据：
   ```json
   {
     "pairs": [
       {
         "query": "查询1",
         "correctDocumentIds": ["doc_1"],
         "metadata": {}
       }
     ]
   }
   ```
2. 粘贴到文本框中
3. 点击"批量收集"按钮

#### 查看收集的对
1. 设置筛选条件（可选）：
   - 来源
   - 集合
   - 国家代码
   - 数量限制
2. 点击"获取 Query-Pairs"按钮
3. 查看收集的对列表

#### 导出为评估数据集
1. 选择要导出的对
2. 点击"导出为评估数据集"按钮
3. 下载导出的数据

**适用场景**:
- 收集用户查询和正确答案
- 构建评估数据集
- 分析用户查询模式
- 优化检索系统

---

### 10. 💬 增强对话 (Chat)

**用途**: 使用 RAG 增强的对话功能

**使用方法**:

#### 回答路线问题
1. 选择对话类型：`回答路线问题`
2. 填写表单：
   - 问题 *（如：`黄金圈适合冬天去吗？`）
   - 路线方向 ID（可选）
   - 国家代码（可选）
3. 点击"发送请求"按钮
4. 查看回答结果

#### 解释路线选择
1. 选择对话类型：`解释路线选择`
2. 填写表单：
   - 已选路线 ID *（如：`route_001`）
   - 备选路线 ID *（如：`route_002`）
   - 国家代码（可选）
3. 点击"发送请求"按钮
4. 查看解释结果

#### 获取目的地深度信息
1. 选择对话类型：`目的地深度信息`
2. 填写表单：
   - 地点 ID *（如：`reykjavik`）
   - 国家代码（可选）
3. 点击"发送请求"按钮
4. 查看目的地信息：
   - Tips（提示）
   - Local Insights（当地洞察）
   - Route Insights（路线洞察）
   - Credibility（可信度信息）

**适用场景**:
- 回答用户关于路线的疑问
- 解释为什么推荐某条路线
- 获取目的地的详细信息
- 提供个性化的旅行建议

---

## 🚀 快速开始

### 首次使用流程

1. **设置知识库**:
   - 进入"知识库"标签页
   - 点击"重建索引"按钮
   - 等待 10-20 分钟完成索引

2. **验证索引**:
   - 进入"统计"标签页
   - 查看文档总数和集合信息
   - 确认索引成功

3. **测试检索**:
   - 进入"检索测试"标签页
   - 使用 Chunk 检索测试查询
   - 验证检索结果

4. **管理文档**:
   - 进入"文档管理"标签页
   - 查看、编辑、删除文档

---

## 📌 最佳实践

1. **定期重建索引**: 当知识库文件更新后，建议重建索引以确保数据最新

2. **使用 Chunk 检索**: 新的 Chunk 检索接口性能更好，推荐使用

3. **收集 Query-Pairs**: 定期收集用户查询和正确答案，用于持续优化

4. **评估检索质量**: 定期评估检索效果，优化检索参数

5. **维护文档质量**: 及时更新和修正文档内容，确保知识库准确性

---

## ⚠️ 注意事项

1. **清空索引操作**: 清空索引会删除所有数据，请谨慎操作

2. **重建索引时间**: 重建索引需要较长时间（10-20 分钟），请耐心等待

3. **后端服务**: 确保后端服务 `http://localhost:3000/api` 正在运行

4. **API 代理**: 所有 API 请求都通过 Next.js API 路由代理到后端服务

5. **错误处理**: 如果遇到错误，请查看浏览器控制台和服务器日志

---

## 🔗 相关资源

- [RAG API 接口文档](./RAG-API-DOCS.md)（如果存在）
- [环境变量配置](./ENV-SETUP.md)
- 后端服务文档: `http://localhost:3000/api-docs`

---

**最后更新**: 2026-01-23
