### 后端管理系统（Admin Dashboard）

**使用方**：ML 工程师、运维人员、数据工程师  
**用途**：管理训练流程、模型版本、RAG 评估、数据收集  
**认证**：需要管理员权限（当前使用 `@Public()` 临时开放）  
**基础路径**：`/api/training`、`/api/rag`

### 前端用户系统（Frontend）

**使用方**：C 端用户  
**用途**：用户反馈收集（可选，通常由后端自动收集）  
**认证**：需要用户认证（当前使用 `@Public()` 临时开放）  
**基础路径**：`/api/rag`

---

## 后端管理系统接口（Admin Dashboard）

> **注意**：以下接口仅供后端管理系统使用，前端用户系统不应调用。

---

## 后端管理系统接口

### 一、迭代部署工作流管理

#### 1.1 执行迭代部署工作流

**端点**：`POST /api/training/workflows/execute`

**说明**：执行完整的迭代部署工作流，包括数据准备、模型训练、评估、部署等步骤。

**请求体**：
```json
{
  "minScore": 0.8,
  "minReward": 0,
  "batchSize": 1000,
  "modelConfig": {
    "model_type": "claude-3-5-sonnet",
    "provider": "anthropic"
  },
  "trainingConfig": {
    "learning_rate": 0.0001,
    "num_epochs": 3,
    "batch_size": 32
  },
  "autoDeploy": false
}
```

**参数说明**：

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `minScore` | number | 否 | 0.8 | 最小验证分数阈值 |
| `minReward` | number | 否 | 0 | 最小 reward 阈值 |
| `batchSize` | number | 否 | 1000 | 训练批次大小 |
| `modelConfig` | object | 否 | - | 模型配置（模型类型、提供商等） |
| `trainingConfig` | object | 否 | - | 训练配置（学习率、epochs 等） |
| `autoDeploy` | boolean | 否 | false | 是否自动部署（如果通过评估） |

**响应示例**：
```json
{
  "success": true,
  "data": {
    "workflowId": "workflow_1705834567890",
    "status": "SUCCESS",
    "steps": [
      {
        "step": "prepare_training_data",
        "status": "SUCCESS",
        "result": {
          "batchId": "batch_1705834567890",
          "trajectoryCount": 1000,
          "stats": {
            "totalTrajectories": 1000,
            "avgScore": 0.85,
            "avgReward": 1.2
          }
        }
      },
      {
        "step": "create_training_job",
        "status": "SUCCESS",
        "result": {
          "jobId": "job_1705834567891"
        }
      },
      {
        "step": "start_training",
        "status": "SUCCESS",
        "result": {
          "jobId": "job_1705834567891",
          "rayJobId": "ray_job_123",
          "mlflowRunId": "mlflow_run_456"
        }
      },
      {
        "step": "wait_training_complete",
        "status": "SUCCESS",
        "result": {
          "modelVersion": "v1.0.0",
          "trainingMetrics": {
            "loss": 0.15,
            "accuracy": 0.92
          }
        }
      },
      {
        "step": "register_model",
        "status": "SUCCESS",
        "result": {
          "version": "v1.0.0",
          "mlflowModelUri": "models:/tripnara-policy-model/v1.0.0"
        }
      },
      {
        "step": "evaluate_model",
        "status": "SUCCESS",
        "result": {
          "accuracy": 0.92,
          "success_rate": 0.95
        }
      },
      {
        "step": "regression_gate",
        "status": "SUCCESS",
        "result": {
          "passed": true,
          "reason": "All metrics improved"
        }
      },
      {
        "step": "deploy_model",
        "status": "SKIPPED",
        "result": {
          "reason": "autoDeploy is false"
        }
      }
    ],
    "modelVersion": "v1.0.0"
  }
}
```

**错误响应**：
```json
{
  "success": false,
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "训练任务失败: ..."
  }
}
```

**使用场景**：
- ML 工程师启动新的模型训练和部署流程
- 自动化 CI/CD 流程中调用

---

#### 1.2 获取工作流状态

**端点**：`GET /api/training/workflows/:workflowId`

**说明**：查询指定工作流的执行状态和进度。

**路径参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `workflowId` | string | 是 | 工作流 ID |

**响应示例**：
```json
{
  "success": true,
  "data": {
    "workflowId": "workflow_1705834567890",
    "status": "RUNNING",
    "currentStep": "start_training",
    "steps": [
      {
        "step": "prepare_training_data",
        "status": "SUCCESS"
      },
      {
        "step": "create_training_job",
        "status": "SUCCESS"
      },
      {
        "step": "start_training",
        "status": "RUNNING"
      }
    ]
  }
}
```

**状态说明**：

| 状态 | 说明 |
|------|------|
| `RUNNING` | 工作流正在执行中 |
| `SUCCESS` | 工作流执行成功 |
| `FAILED` | 工作流执行失败 |
| `BLOCKED` | 工作流被阻塞（如回归门控未通过） |

**使用场景**：
- 管理后台展示工作流执行进度
- 轮询查询工作流状态

---

### 二、模型版本 A/B 测试管理

#### 2.1 创建模型版本对比实验

**端点**：`POST /api/training/models/ab-test/create`

**说明**：创建模型版本的 A/B 测试实验，对比新旧版本的性能。

**请求体**：
```json
{
  "name": "v1.0 vs v1.1 性能对比",
  "description": "对比新版本 v1.1.0 与当前生产版本 v1.0.0 的性能差异",
  "controlVersion": "v1.0.0",
  "treatmentVersion": "v1.1.0",
  "trafficSplit": {
    "control": 50,
    "treatment": 50
  },
  "successMetrics": [
    "accuracy",
    "user_satisfaction",
    "latency"
  ],
  "minSampleSize": 1000,
  "durationDays": 7
}
```

**参数说明**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `name` | string | 是 | 实验名称 |
| `description` | string | 是 | 实验描述 |
| `controlVersion` | string | 是 | 对照组版本（当前生产版本） |
| `treatmentVersion` | string | 是 | 实验组版本（新版本） |
| `trafficSplit` | object | 否 | 流量分配，默认 50/50 |
| `trafficSplit.control` | number | 否 | 对照组流量百分比 |
| `trafficSplit.treatment` | number | 否 | 实验组流量百分比 |
| `successMetrics` | string[] | 是 | 成功指标列表 |
| `minSampleSize` | number | 否 | 最小样本量 |
| `durationDays` | number | 否 | 实验持续时间（天） |

**响应示例**：
```json
{
  "success": true,
  "data": {
    "experimentId": "exp_abc123def456",
    "status": "CREATED",
    "controlVersion": "v1.0.0",
    "treatmentVersion": "v1.1.0"
  }
}
```

**使用场景**：
- ML 工程师创建新模型版本的 A/B 测试
- 管理后台的实验管理界面

---

#### 2.2 分析模型版本对比结果

**端点**：`POST /api/training/models/ab-test/analyze`

**说明**：分析 A/B 测试实验结果，计算改进幅度和统计显著性。

**请求体**：
```json
{
  "experimentId": "exp_abc123def456",
  "controlVersion": "v1.0.0",
  "treatmentVersion": "v1.1.0"
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "experimentId": "exp_abc123def456",
    "controlMetrics": {
      "accuracy": 0.85,
      "user_satisfaction": 4.2,
      "latency": 1200
    },
    "treatmentMetrics": {
      "accuracy": 0.88,
      "user_satisfaction": 4.5,
      "latency": 1100
    },
    "improvement": {
      "accuracy": {
        "absolute": 0.03,
        "percentage": 3.53
      },
      "user_satisfaction": {
        "absolute": 0.3,
        "percentage": 7.14
      },
      "latency": {
        "absolute": -100,
        "percentage": -8.33
      }
    },
    "statisticalSignificance": {
      "accuracy": {
        "pValue": 0.02,
        "significant": true
      },
      "user_satisfaction": {
        "pValue": 0.01,
        "significant": true
      },
      "latency": {
        "pValue": 0.15,
        "significant": false
      }
    },
    "recommendation": "PROMOTE",
    "reasoning": "新版本在 2 个关键指标上显著改进，建议推广"
  }
}
```

**推荐说明**：

| 推荐值 | 说明 |
|--------|------|
| `PROMOTE` | 新版本表现更好，建议推广 |
| `REJECT` | 新版本表现更差，建议拒绝 |
| `CONTINUE` | 结果不明确，建议继续实验 |

**使用场景**：
- ML 工程师分析 A/B 测试结果
- 管理后台的实验结果展示

---

#### 2.3 推广模型版本

**端点**：`POST /api/training/models/ab-test/promote`

**说明**：如果 A/B 测试通过，将新版本设置为生产版本。

**请求体**：
```json
{
  "experimentId": "exp_abc123def456",
  "treatmentVersion": "v1.1.0"
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "message": "模型版本已推广",
    "productionVersion": "v1.1.0"
  }
}
```

**错误响应**（如果 A/B 测试未通过）：
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "模型版本未通过 A/B 测试，不能推广: recommendation=CONTINUE, reasoning=实验结果不明确，建议继续实验"
  }
}
```

**使用场景**：
- ML 工程师在 A/B 测试通过后推广新版本
- 管理后台的一键部署功能

---

### 三、RAG 检索质量评估管理

#### 3.1 评估单次检索质量

**端点**：`POST /api/rag/evaluation/evaluate`

**说明**：评估单次 RAG 检索的质量，返回 Recall@K、MRR、NDCG 等指标。

**请求体**：
```json
{
  "query": "冰岛 F-road 需要什么车辆？",
  "params": {
    "query": "冰岛 F-road 需要什么车辆？",
    "collection": "compliance",
    "countryCode": "IS",
    "tags": ["f-road", "driving"],
    "limit": 10,
    "minScore": 0.5
  },
  "groundTruthDocumentIds": [
    "doc-123",
    "doc-456"
  ]
}
```

**参数说明**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `query` | string | 是 | 查询文本 |
| `params` | object | 是 | 检索参数（与 RAG 检索接口相同） |
| `groundTruthDocumentIds` | string[] | 是 | 正确答案文档 ID 列表 |

**响应示例**：
```json
{
  "success": true,
  "data": {
    "recallAtK": {
      "1": 0.5,
      "5": 0.8,
      "10": 1.0
    },
    "mrr": 0.67,
    "ndcg": {
      "1": 0.5,
      "5": 0.75,
      "10": 0.9
    },
    "retrievedIds": [
      "doc-123",
      "doc-789",
      "doc-456"
    ],
    "scores": [
      0.85,
      0.72,
      0.68
    ]
  }
}
```

**指标说明**：

| 指标 | 说明 | 范围 |
|------|------|------|
| `recallAtK` | 前 K 个结果中包含正确答案的比例 | 0-1，越高越好 |
| `mrr` | 平均倒数排名（第一个正确答案的排名倒数） | 0-1，越高越好 |
| `ndcg` | 归一化折损累积增益 | 0-1，越高越好 |

**使用场景**：
- 数据工程师评估 RAG 检索质量
- 管理后台的 RAG 质量监控

---

#### 3.2 批量评估检索质量

**端点**：`POST /api/rag/evaluation/evaluate-batch`

**说明**：批量评估多个查询的检索质量，返回平均指标和每个查询的详细结果。

**请求体**：
```json
{
  "testCases": [
    {
      "query": "冰岛 F-road 需要什么车辆？",
      "params": {
        "query": "冰岛 F-road 需要什么车辆？",
        "collection": "compliance",
        "countryCode": "IS",
        "limit": 10
      },
      "groundTruthDocumentIds": ["doc-123", "doc-456"]
    },
    {
      "query": "Rail Pass 在冰岛如何使用？",
      "params": {
        "query": "Rail Pass 在冰岛如何使用？",
        "collection": "compliance",
        "countryCode": "IS",
        "limit": 10
      },
      "groundTruthDocumentIds": ["doc-789"]
    }
  ]
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "averageRecallAtK": {
      "1": 0.5,
      "5": 0.75,
      "10": 0.9
    },
    "averageMRR": 0.65,
    "averageNDCGAtK": {
      "1": 0.5,
      "5": 0.7,
      "10": 0.85
    },
    "perQueryResults": [
      {
        "query": "冰岛 F-road 需要什么车辆？",
        "recallAtK": {
          "1": 0.5,
          "5": 0.8,
          "10": 1.0
        },
        "mrr": 0.67,
        "ndcg": {
          "1": 0.5,
          "5": 0.75,
          "10": 0.9
        }
      },
      {
        "query": "Rail Pass 在冰岛如何使用？",
        "recallAtK": {
          "1": 0.0,
          "5": 0.5,
          "10": 1.0
        },
        "mrr": 0.5,
        "ndcg": {
          "1": 0.0,
          "5": 0.5,
          "10": 0.8
        }
      }
    ]
  }
}
```

**使用场景**：
- 数据工程师批量评估 RAG 检索质量
- 管理后台的 RAG 质量报告

---

### 四、query-document 对收集管理

#### 4.1 收集 query-document 对

**端点**：`POST /api/rag/query-pairs/collect`

**说明**：手动收集用户查询和正确答案文档的配对，用于 RAG 评估和微调。

**请求体**：
```json
{
  "query": "冰岛 F-road 需要什么车辆？",
  "correctDocumentIds": [
    "doc-123",
    "doc-456"
  ],
  "metadata": {
    "source": "MANUAL_ANNOTATION",
    "userId": "user-123",
    "sessionId": "session-456",
    "collection": "compliance",
    "countryCode": "IS",
    "tags": ["f-road", "driving"]
  }
}
```

**参数说明**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `query` | string | 是 | 查询文本 |
| `correctDocumentIds` | string[] | 是 | 正确答案文档 ID 列表 |
| `metadata` | object | 否 | 元数据 |
| `metadata.source` | string | 否 | 来源（USER_QUERY \| MANUAL_ANNOTATION \| AUTO_ANNOTATION） |
| `metadata.userId` | string | 否 | 用户 ID |
| `metadata.sessionId` | string | 否 | 会话 ID |
| `metadata.collection` | string | 否 | 集合名称 |
| `metadata.countryCode` | string | 否 | 国家代码 |
| `metadata.tags` | string[] | 否 | 标签列表 |

**响应示例**：
```json
{
  "success": true,
  "data": {
    "pairId": "pair_1705834567890",
    "message": "query-document 对已收集"
  }
}
```

**使用场景**：
- 数据工程师手动标注评估数据集
- 管理后台的数据标注工具

---

#### 4.2 从用户查询自动收集

**端点**：`POST /api/rag/query-pairs/collect-from-query`

**说明**：基于检索结果和用户反馈自动收集 query-document 对。

**请求体**：
```json
{
  "query": "冰岛 F-road 需要什么车辆？",
  "retrievedResults": [
    {
      "id": "doc-123",
      "score": 0.85
    },
    {
      "id": "doc-789",
      "score": 0.72
    }
  ],
  "userFeedback": {
    "clickedDocumentIds": ["doc-123"],
    "relevantDocumentIds": ["doc-123", "doc-456"],
    "irrelevantDocumentIds": ["doc-789"]
  }
}
```

**参数说明**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `query` | string | 是 | 查询文本 |
| `retrievedResults` | object[] | 是 | 检索结果列表 |
| `retrievedResults[].id` | string | 是 | 文档 ID |
| `retrievedResults[].score` | number | 是 | 相似度分数 |
| `userFeedback` | object | 否 | 用户反馈 |
| `userFeedback.clickedDocumentIds` | string[] | 否 | 用户点击的文档 ID |
| `userFeedback.relevantDocumentIds` | string[] | 否 | 用户标记为相关的文档 ID |
| `userFeedback.irrelevantDocumentIds` | string[] | 否 | 用户标记为不相关的文档 ID |

**响应示例**：
```json
{
  "success": true,
  "data": {
    "pairId": "pair_1705834567890",
    "correctDocumentIds": ["doc-123", "doc-456"],
    "message": "query-document 对已收集"
  }
}
```

**使用场景**：
- 前端系统自动收集用户反馈数据
- 后端系统从用户行为日志中提取

---

#### 4.3 批量收集 query-document 对

**端点**：`POST /api/rag/query-pairs/collect-batch`

**说明**：批量收集多个 query-document 对。

**请求体**：
```json
{
  "pairs": [
    {
      "query": "冰岛 F-road 需要什么车辆？",
      "correctDocumentIds": ["doc-123"],
      "metadata": {
        "source": "MANUAL_ANNOTATION",
        "collection": "compliance"
      }
    },
    {
      "query": "Rail Pass 在冰岛如何使用？",
      "correctDocumentIds": ["doc-456"],
      "metadata": {
        "source": "AUTO_ANNOTATION",
        "collection": "compliance"
      }
    }
  ]
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "pairIds": [
      "pair_1705834567890",
      "pair_1705834567891"
    ],
    "successCount": 2,
    "totalCount": 2
  }
}
```

**使用场景**：
- 数据工程师批量导入评估数据集
- 管理后台的数据导入功能

---

#### 4.4 获取收集的 query-document 对

**端点**：`GET /api/rag/query-pairs`

**说明**：获取已收集的 query-document 对列表，支持筛选和分页。

**查询参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `source` | string | 否 | 来源过滤（USER_QUERY \| MANUAL_ANNOTATION \| AUTO_ANNOTATION） |
| `collection` | string | 否 | 集合过滤 |
| `countryCode` | string | 否 | 国家代码过滤 |
| `limit` | number | 否 | 返回数量限制，默认 100 |

**响应示例**：
```json
{
  "success": true,
  "data": {
    "pairs": [
      {
        "id": "pair_1705834567890",
        "query": "冰岛 F-road 需要什么车辆？",
        "correctDocumentIds": ["doc-123", "doc-456"],
        "metadata": {
          "source": "MANUAL_ANNOTATION",
          "collection": "compliance",
          "countryCode": "IS",
          "timestamp": "2025-01-21T10:00:00Z"
        }
      }
    ],
    "total": 100
  }
}
```

**使用场景**：
- 管理后台查看已收集的数据
- 数据工程师导出评估数据集

---

#### 4.5 导出为评估数据集格式

**端点**：`POST /api/rag/query-pairs/export-for-evaluation`

**说明**：将 query-document 对导出为评估数据集格式。

**请求体**：
```json
{
  "pairs": [
    {
      "query": "冰岛 F-road 需要什么车辆？",
      "correctDocumentIds": ["doc-123", "doc-456"]
    },
    {
      "query": "Rail Pass 在冰岛如何使用？",
      "correctDocumentIds": ["doc-789"]
    }
  ]
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "evaluationDataset": [
      {
        "query": "冰岛 F-road 需要什么车辆？",
        "ground_truth_document_ids": ["doc-123", "doc-456"]
      },
      {
        "query": "Rail Pass 在冰岛如何使用？",
        "ground_truth_document_ids": ["doc-789"]
      }
    ]
  }
}
```

**使用场景**：
- 数据工程师导出评估数据集用于 RAG 微调
- 管理后台的数据导出功能

---